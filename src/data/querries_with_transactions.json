{
  "drop_trigger" : "DROP TRIGGER IF EXISTS xlog ON transaction_log;",
  "create_functions" : "CREATE OR REPLACE FUNCTION tr_log() RETURNS trigger AS $$\n\tDECLARE\n\t\txbalance bigint;\n    BEGIN\n\t\tselect acc.balance into xbalance from accounts acc where acc.account_id = NEW.credit_account;\n\t\tIF xbalance >= NEW.transaction_sum THEN\n\t\t\tNEW.status = 'APPROVED';\n\t\t\tupdate accounts\n    \t\tset balance = balance - NEW.transaction_sum \n    \t\twhere account_id = NEW.credit_account;\n    \t\tupdate accounts\n    \t\tset balance = balance + NEW.transaction_sum \n    \t\twhere account_id = NEW.debit_account;\n\t\t\tupdate contracts\n\t\t\tset current_balance = current_balance - NEW.transaction_sum\n\t\t\twhere contract_number = NEW.contract_number AND NEW.transaction_type = 'Loan principal repayment' \n\t\t\tOR NEW.transaction_type ='Deposit principal repayment' OR NEW.transaction_type = 'Attracted loan principal payment'\n\t\t\tOR NEW.transaction_type = 'Securities principal repayment' OR NEW.transaction_type = 'Issued bond`s principal repayment';\n\t\t\treturn NEW;\n\t\t\t\n\t\tELSE \n\t\t\tNEW.status = 'DECLINED';\n\t\t\treturn NEW;\n\t\tEND if;\n\n    END;\n\t\n$$ LANGUAGE 'plpgsql';",
  "create_trigger" : "CREATE TRIGGER xlog\n     BEFORE INSERT ON transaction_log\n     FOR EACH ROW EXECUTE FUNCTION tr_log();"
}